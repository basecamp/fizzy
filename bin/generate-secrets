#!/bin/bash

# Script de ayuda para generar credenciales de Fizzy
# Uso: bash bin/generate-secrets

set -e

echo "üîê Generador de Secretos para Fizzy"
echo "===================================="
echo ""

# Generar SECRET_KEY_BASE
echo "üìù Generando SECRET_KEY_BASE..."
SECRET_KEY_BASE=$(openssl rand -hex 64)
echo "SECRET_KEY_BASE=$SECRET_KEY_BASE"
echo ""

# Generar VAPID keys
echo "üìù Generando VAPID Keys para notificaciones push..."
echo "   (Esto puede tomar un momento...)"
echo ""

# Intentar generar con Ruby si est√° disponible localmente
if command -v ruby &> /dev/null && gem list webpush -i &> /dev/null; then
  VAPID_OUTPUT=$(ruby -e "
    require 'webpush'
    vapid_key = Webpush.generate_key
    puts 'VAPID_PUBLIC_KEY=' + vapid_key.public_key
    puts 'VAPID_PRIVATE_KEY=' + vapid_key.private_key
  ")
  echo "$VAPID_OUTPUT"
elif command -v docker &> /dev/null; then
  echo "   Usando Docker para generar las llaves..."
  docker run --rm ruby:3.4.7-slim bash -c "
    gem install webpush -q && 
    ruby -e \"
      require 'webpush'
      vapid_key = Webpush.generate_key
      puts 'VAPID_PUBLIC_KEY=' + vapid_key.public_key
      puts 'VAPID_PRIVATE_KEY=' + vapid_key.private_key
    \"
  " 2>/dev/null
else
  echo "‚ùå No se pudo generar VAPID keys."
  echo "   Instala Ruby y la gema webpush, o Docker para generar las llaves."
  echo ""
  echo "   Con Ruby:"
  echo "     gem install webpush"
  echo "     ruby -e \"require 'webpush'; k = Webpush.generate_key; puts 'PUBLIC: ' + k.public_key; puts 'PRIVATE: ' + k.private_key\""
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ ¬°Secretos generados exitosamente!"
echo ""
echo "üìã Copia estos valores a tu archivo .env en Dokploy"
echo "===================================="
echo ""
echo "Genera tambi√©n una contrase√±a segura para MySQL:"
echo "MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)"
echo ""
echo "‚ö†Ô∏è  IMPORTANTE: Guarda estos valores de forma segura."
echo "    No los compartas p√∫blicamente ni los commits al repositorio."
