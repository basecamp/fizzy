#!/usr/bin/env bash

set -e

COMPOSE_OPTIONS="-f docker-compose.beamer-testbed.yml"
BEAMER_OPTIONS="--debug --directory ./storage"

# Show usage
show_usage() {
  echo "Usage: $0 {start|stop|logs|console|bash|server|run-migrations} [options]"
  echo ""
  echo "Lifecycle commands:"
  echo "  start              Build and start all services"
  echo "  stop               Stop all services"
  echo "  clean              Clean up testbed state, stopping the cluster if necessary"
  echo "  exec <node> <cmd>  Execute command in specified node"
  echo ""
  echo "Database manipulation:"
  echo "  create-accounts    Create sample accounts in the database"
  echo ""
  echo "Debugging commands:"
  echo "  logs               Show logs (pass -f to follow)"
  echo "  console <node>     Open Rails console (default: fizzy-01)"
  echo "  bash <node>        Open bash shell (default: fizzy-01)"
}

# Functions to introspect on the cluster
fizzy_nodes() {
  fizzy_nodes=$(yq -r ".services | keys | .[]" docker-compose.beamer-testbed.yml | grep fizzy- | sort)

  if [ -z "$fizzy_nodes" ]; then
    echo "Error: No fizzy-* services found in docker-compose file"
    exit 1
  fi

  echo "$fizzy_nodes"
}

fizzy_default_writer_node() {
  # TODO: dynamically find the writer for PRIMARY_ZONE
  echo "fizzy-01"
}

# Nodes ending in 1 are the writers
fizzy_writer_nodes() {
  fizzy_nodes | grep -E '01$'
}

# Nodes ending in 1 are the writers
fizzy_reader_nodes() {
  fizzy_nodes | grep -E '02$'
}

# Function to wait for a container to be healthy
wait_for_container() {
  local container=$1
  local max_iterations=10
  local iteration=0

  while ! docker compose $COMPOSE_OPTIONS exec -T "$container" curl -f -s http://localhost/up >/dev/null 2>&1; do
    echo "wait_for_container: Waiting for $container..."
    sleep 2
    iteration=$((iteration + 1))

    if [ $iteration -ge $max_iterations ]; then
      echo "wait_for_container: Timeout waiting for $container after ${max_iterations} iterations"
      exit 1
    fi
  done

  echo "wait_for_container: done waiting for $container"
}

# Function to wait until beamer is healthy in the container
wait_for_beamer() {
  while ! bin/beamer $BEAMER_OPTIONS status >/dev/null 2>&1; do
    echo "wait_for_beamer: Waiting for beamer to be ready..."
    sleep 1
  done

  echo "wait_for_beamer: done waiting for beamer"
}

wait_for_zone_configurations() {
  wait_for_beamer

  while [ ! -f storage/zones_configured ]; do
    echo "wait_for_zone_configurations: Waiting for zones to be ready..."
    sleep 1
  done

  echo "wait_for_zone_configurations: done waiting for zones"
}

# Function to wait until the default writer has created and replicated the untenanted database
wait_for_default_writer() {
  while [ ! -f storage/untenanted/development.sqlite3 ] ; do
    echo "wait_for_default_writer: Waiting for untenanted database to be replicated..."
    sleep 1
  done

  echo "wait_for_default_writer: done waiting for untenanted database."
}

# Function to wait until the default writer has created and replicated the untenanted database
wait_for_zone_writer() {
  while [ ! -f storage/zones/development/$SOLID_QUEUE_ZONE/queue.sqlite3 ] ; do
    echo "wait_for_zone_writer: Waiting for zone queue database to be replicated..."
    sleep 1
  done

  echo "wait_for_zone_writer: done waiting for zone queue database."
}

# Function to wait until all migrations have been run locally
wait_for_migrations() {
  while [ ! -f storage/migrations_done ]; do
    echo "wait_for_migrations: Waiting for migrations..."
    sleep 1
  done

  echo "wait_for_migrations: done waiting for migrations."
}

# Function to configure kamal-proxy
# TODO: set up more containers as read targets
configure_proxy() {
  echo "configure_proxy: starting..."

  local writer_target="$writer"
  for writer in $writers; do
    if [ -n "$writer_target" ]; then
      writer_target+=","
    fi
    writer_target+="$writer"
  done

  command="kamal-proxy deploy fizzy --host fizzy.localhost --dynamic-load-balancing"
  command="$command --default-writer $(fizzy_default_writer_node)"
  for node in $(fizzy_writer_nodes) ; do
    command="$command --target $node"
  done
  for node in $(fizzy_reader_nodes) ; do
    command="$command --read-target $node"
  done

  echo "configure_proxy: configuring with: $command"

  docker compose $COMPOSE_OPTIONS exec -T kamal-proxy $command
}

# Start command
cmd_start() {
  local nodes=$(fizzy_nodes)
  local first_fizzy=$(echo "$nodes" | head -n 1)

  # Set UID and GID for Docker user mapping
  export DOCKER_UID=$(id -u)
  export DOCKER_GID=$(id -g)

  # Get GitHub token from gh CLI
  echo "Getting GitHub token from gh CLI..."
  export GITHUB_TOKEN=$(gh auth token)

  if [ -z "$GITHUB_TOKEN" ]; then
    echo "Error: Failed to get GitHub token from gh CLI"
    echo "Make sure you're authenticated with: gh auth login"
    exit 1
  fi

  # Create tmp directories with proper permissions
  echo "Creating temporary directories..."
  for node in $nodes; do
    mkdir -p "./tmp/beamer-testbed/$node/storage"
    rm -rf   "./tmp/beamer-testbed/$node/tmp"
    mkdir -p "./tmp/beamer-testbed/$node/tmp"
  done

  echo "Building Docker image for $first_fizzy..."
  docker compose $COMPOSE_OPTIONS build "$first_fizzy"

  echo "Starting services in detached mode..."
  docker compose $COMPOSE_OPTIONS down
  docker compose $COMPOSE_OPTIONS up -d

  # Wait for and register each fizzy container
  for node in $nodes; do
    wait_for_container $node
  done
  configure_proxy

  echo ""
  echo "All containers are ready and registered!"
  echo "You can access the application at: http://fizzy.localhost:3006"
}

# Stop command
cmd_stop() {
  echo "Stopping services..."
  docker compose $COMPOSE_OPTIONS down
}

cmd_clean() {
  cmd_stop

  echo "Cleaning up testbed state..."
  rm -rf ./tmp/beamer-testbed
}

cmd_exec() {
  local node="$1"
  shift
  echo "Running command in $node: $*"

  docker compose $COMPOSE_OPTIONS exec "$node" "$@"
}

# Logs command
cmd_logs() {
  docker compose $COMPOSE_OPTIONS logs "$@"
}

# Console command
cmd_console() {
  local node="${1:-fizzy-01}"

  echo "Opening Rails console in $node..."
  docker compose $COMPOSE_OPTIONS exec "$node" bin/rails console
}

# Bash command
cmd_bash() {
  local node="${1:-fizzy-01}"

  echo "Opening bash shell in $node..."
  docker compose $COMPOSE_OPTIONS exec "$node" bash
}

# Server command (runs inside container)
cmd_server() {
  # Check if foreman is installed
  if ! command -v foreman >/dev/null 2>&1; then
    echo "Foreman not found, installing..."
    gem install foreman
  fi

  # Clean up any stale .beamer.sock files
  echo "Cleaning up stale socket files..."
  find . -path '*/.beamer/*/.beamer.sock' -type s -delete 2>/dev/null || true

  mkdir -p ./storage/tenants
  mkdir -p ./storage/untenanted

  echo "Starting all the things..."
  exec foreman start -f Procfile.beamer-testbed
}

# Create sample accounts in each zone
cmd_create_accounts() {
  for host in $(fizzy_writer_nodes) ; do
    docker compose $COMPOSE_OPTIONS exec -T $host script/create-testbed-account.rb
  done
}

# Run the rails server
cmd_run_web() {
  wait_for_migrations

  bin/thrust bin/rails server
}

# Run migrations command (runs inside container)
cmd_run_migrations() {
  wait_for_zone_configurations

  if [[ $(hostname) -eq $(fizzy_default_writer_node) ]] ; then
    echo "cmd_run_migrations: I am the default writer, going immediately..."
    bin/rails db:prepare
  elif bin/beamer $BEAMER_OPTIONS is-primary --zone $SOLID_QUEUE_ZONE ; then
    echo "cmd_run_migrations: I am a zone writer, waiting for default writer..."
    wait_for_default_writer
  else
    # TODO migrations should be smart enough not to run if not on the zone writer
    echo "cmd_run_migrations: I am a replica, waiting for zone writer..."
    wait_for_zone_writer
  fi

  bin/rails db:prepare
  touch storage/migrations_done

  # Wait indefinitely until interrupted
  echo "cmd_run_migrations: Waiting indefinitely (press Ctrl-C to exit)..."
  while true; do
    sleep 3600
  done
}

# Run the beamer daemon (runs inside container)
cmd_run_beamer() {
  set -m

  echo "cmd_run_beamer: Starting..."
  rm -rf storage/zones_configured
  bin/beamer $BEAMER_OPTIONS run --primary $(fizzy_default_writer_node) &

  wait_for_beamer

  # Configure zones
  for node in $(fizzy_writer_nodes); do
    zone=$(yq -r ".services[\"${node}\"].environment.SOLID_QUEUE_ZONE" docker-compose.beamer-testbed.yml)
    bin/beamer $BEAMER_OPTIONS switch --zone $zone --primary $node
  done

  # make the default zone read-only
  bin/beamer $BEAMER_OPTIONS switch --zone default --no-primary

  # Bring beamer daemon process to foreground
  echo "cmd_run_beamer: Okey dokey on $(hostname)"
  touch storage/zones_configured
  fg
}

# Main command dispatch
case "${1:-}" in
start)
  cmd_start
  ;;
stop)
  cmd_stop
  ;;
clean)
  cmd_clean
  ;;
exec)
  shift
  cmd_exec "$@"
  ;;
logs)
  shift
  cmd_logs "$@"
  ;;
console)
  shift
  cmd_console "$@"
  ;;
bash)
  shift
  cmd_bash "$@"
  ;;
server)
  cmd_server
  ;;
create-accounts)
  cmd_create_accounts
  ;;
run-web)
  cmd_run_web
  ;;
run-migrations)
  cmd_run_migrations
  ;;
run-beamer)
  cmd_run_beamer
  ;;
*)
  show_usage
  ;;
esac
