# Docker Setup for Fizzy

Run Fizzy locally with Docker Compose for testing and development.

## Quick Start

See [GETTING-STARTED.md](GETTING-STARTED.md) for step-by-step instructions.

## Architecture

### Services

**fizzy** (Application)
- Ruby 3.4.7 on Debian slim
- Production environment with SQLite databases
- Non-root user (rails:rails) with automatic permission fixes
- Health check on /up endpoint
- Internal port 80

**nginx** (Reverse Proxy)
- Nginx on Alpine Linux
- Self-signed SSL certificates for localhost
- HTTP (port 80) redirects to HTTPS (port 443)
- WebSocket support for ActionCable
- Proxies to fizzy container

### Volumes

- `fizzy_storage` - SQLite databases and file uploads
- `fizzy_logs` - Application logs

### Network

- `fizzy_network` - Bridge network connecting services

## Configuration

### Environment Variables

Generated by `generate-secrets.ps1` or `generate-secrets.sh`:

```bash
SECRET_KEY_BASE=...           # Rails secret key
VAPID_PRIVATE_KEY=...         # Web push notifications (private)
VAPID_PUBLIC_KEY=...          # Web push notifications (public)
MULTI_TENANT=false            # Single-tenant mode for local dev
```

### SSL Certificates

Generated by `nginx/ssl/generate-cert.ps1` or `generate-cert.sh`:

- **Certificate:** `nginx/ssl/localhost.crt`
- **Key:** `nginx/ssl/localhost.key`
- **Valid for:** 365 days
- **Common Name:** localhost
- **SAN:** DNS:localhost, IP:127.0.0.1

Copy the output to `SECRET_KEY_BASE` in `.env`

#### Generate VAPID Keys (for push notifications):

```bash
docker run --rm -it ruby:3.4.7-slim bash -c "gem install web-push && irb"
```

Then in the IRB console:
```ruby
require 'web-push'
vapid_key = WebPush.generate_key
puts "VAPID_PRIVATE_KEY=#{vapid_key.private_key}"
puts "VAPID_PUBLIC_KEY=#{vapid_key.public_key}"
```

Copy both keys to your `.env` file.

### 3. Build and Start the Application

```bash
docker-compose build
docker-compose up -d
```

### 4. Access Fizzy

Open your browser and navigate to:
- **HTTPS:** https://localhost
- **HTTP:** http://localhost (will redirect to HTTPS)

⚠️ **Note:** Your browser will show a security warning because the SSL certificate is self-signed. This is expected - click "Advanced" and proceed to the site.

### 5. Login

Fizzy uses username-based local authentication:

1. On the login page, enter any username (letters, numbers, and underscores only)
2. Click "Let's go"
3. A workspace will be created automatically for new usernames
4. You'll be logged in immediately

**Example usernames:**
- `admin`
- `john_doe`
- `test123`

No email or password required!

## Useful Commands

### View Logs
```bash
docker-compose logs -f fizzy     # Follow Fizzy logs
docker-compose logs -f nginx     # Follow Nginx logs
docker-compose logs -f           # Follow all logs
```

### Access Rails Console
```bash
docker-compose exec fizzy bin/rails console
```

### Stop the Application
```bash
docker-compose down              # Stop and remove containers
docker-compose down -v           # Stop, remove containers and volumes
```

### Restart Services
```bash
docker-compose restart           # Restart all services
docker-compose restart fizzy     # Restart only Fizzy
```

### Rebuild After Code Changes
```bash
docker-compose build
docker-compose up -d
```

### Database Management

**Reset Database:**
```bash
docker-compose exec fizzy bin/rails db:reset
```

**Load Fixtures:**
```bash
docker-compose exec fizzy bin/rails db:fixtures:load
```

**Run Migrations:**
```bash
docker-compose exec fizzy bin/rails db:migrate
```

## Troubleshooting

### Certificate Issues

If you see certificate errors, make sure:
1. The certificate files exist in `nginx/ssl/`
2. The hosts file entry for `fizzy.local` is correct
3. You're accessing via `https://fizzy.local` (not `localhost`)

### Application Won't Start

Check the logs:
```bash
docker-compose logs fizzy
```

Common issues:
- Missing environment variables in `.env`
- Invalid SECRET_KEY_BASE or VAPID keys

### Port Conflicts

If ports 80 or 443 are already in use, edit `docker-compose.yml` to change the ports:

```yaml
nginx:
  ports:
    - "8443:443"  # Use port 8443 instead of 443
    - "8080:80"   # Use port 8080 instead of 80
```

Then access via: https://fizzy.local:8443

### Database Persistence

The SQLite database is stored in a Docker volume. To completely reset:

```bash
docker-compose down -v
docker-compose up -d
```

## Configuration Options

### Single vs Multi-Tenant Mode

Edit `.env` to change:
```
MULTI_TENANT=false  # Single tenant (one account)
MULTI_TENANT=true   # Multi-tenant (multiple accounts)
```

### Email Configuration

To enable email functionality, configure SMTP settings in `.env`:

```
SMTP_ADDRESS=smtp.sendgrid.net
SMTP_USERNAME=apikey
SMTP_PASSWORD=your-sendgrid-api-key
MAILER_FROM_ADDRESS=noreply@yourdomain.com
```

## Production Considerations

⚠️ **This setup is for local testing only!**

For production deployment:
1. Use proper SSL certificates (Let's Encrypt, etc.)
2. Use a production-grade database (PostgreSQL/MySQL)
3. Configure proper secret management
4. Set up proper monitoring and backups
5. Follow the deployment guide in the main README.md

## File Structure

```
.
├── docker-compose.yml          # Main compose configuration
├── .env.example                # Environment variables template
├── .env                        # Your environment variables (create this)
├── nginx/
│   ├── nginx.conf             # Nginx configuration
│   └── ssl/
│       ├── generate-cert.sh   # Bash script for cert generation
│       ├── generate-cert.ps1  # PowerShell script for cert generation
│       ├── fizzy.crt          # SSL certificate (generated)
│       └── fizzy.key          # SSL private key (generated)
└── Dockerfile                  # Application container definition
```

## Support

For issues with Fizzy itself, see the main [README.md](../README.md) and [CONTRIBUTING.md](../CONTRIBUTING.md).

For Docker-specific issues, check:
- Docker logs: `docker-compose logs`
- Container status: `docker-compose ps`
- Network connectivity: `docker network inspect fizzy_fizzy_network`
